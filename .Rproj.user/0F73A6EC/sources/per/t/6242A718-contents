interventionBias <-
  function(outcome,
           intervention,
           outcomeVars = NULL,
           interventionVars = NULL,
           data,
           n = 1000,
           bias = c(10, 20, 30, 40)) {
    if (is.null(outcomeVars)) {
      outcomeVars <-
        names(data)[-which(names(data) %in% c(outcome, intervention))]
    }
    if (is.null(interventionVars)) {
      interventionVars <- outcomeVars
    }
    if (max(bias) > 1) {
      bias <- bias / 100
    }
    fit.outcome <- NULL
    fit.intervention <- NULL
    # Randomly sample the data and "inflate" risk for HHC patients
    bs <- data[sample(nrow(data), 1000),]
    bs$adjust <- runif(nrow(bs))
    outcome.frame <-
      cbind(bs[outcome], bs[, which(names(bs) %in% outcomeVars)])
    outcomeFormula <- formula(outcome.frame)
    fit.outcome <-
      glm(outcomeFormula, data = bs, family = binomial)
    #margins.outcome <- margins(fit.outcome)
    intervention.frame <-
      cbind(bs[intervention], bs[, which(names(bs) %in% interventionVars)])
    interventionFormula <- formula(intervention.frame)
    fit.intervention <-
      glm(interventionFormula, data = bs, family = binomial)
    #margins.intervention <- margins(fit.intervention)
    fit <-
      list(
        fit.outcome = fit.outcome,
        fit.intervention = fit.intervention,
        fit.risk = NULL
      )
    for (i in 1:length(bias)) {
      bs$risk <-
        ifelse(bs[, which(names(bs) %in% intervention)] == 1 &
                 bs[, which(names(bs) %in% outcome)] == 0 &
                 bs$adjust >= bias[i], 1, bs[[which(names(bs) %in% outcome)]])
      risk.frame <-
        cbind(bs['risk'], bs[, which(names(bs) %in% outcomeVars)])
      riskFormula <- formula(risk.frame)
      fit$fit.risk[[i]] <-
        glm(riskFormula, data = bs, family = binomial)
    }
    out <-
      list(
        fit.intervention = fit.intervention,
        fit.outcome = fit.outcome,
        fit.risk = fit$fit.risk
      )
    out
  }
